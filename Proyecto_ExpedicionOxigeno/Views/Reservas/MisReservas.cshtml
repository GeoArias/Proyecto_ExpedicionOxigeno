
    @inherits System.Web.Mvc.WebViewPage
    @using System.Linq
    @using System.Globalization
    @using System.Web.Mvc
    @{
        ViewBag.Title = "Mis Reservas";
        Layout = "~/Views/Shared/_Layout.cshtml";
        var reservas = Model as List<Proyecto_ExpedicionOxigeno.Models.BookingAppointmentCustomed>;
        var now = DateTime.Now;
        var futuras = reservas != null
            ? reservas
                .Where(r => r.end != null && r.end.dateTime != null && r.end.dateTime >= now)
                .OrderBy(r => r.start != null && r.start.dateTime != null ? r.start.dateTime : DateTime.MinValue)
                .ToList()
            : new List<Proyecto_ExpedicionOxigeno.Models.BookingAppointmentCustomed>();
        var pasadas = reservas != null
            ? reservas
                .Where(r => r.end != null && r.end.dateTime != null && r.end.dateTime < now)
                .OrderByDescending(r => r.start != null && r.start.dateTime != null ? r.start.dateTime : DateTime.MinValue)
                .ToList()
            : new List<Proyecto_ExpedicionOxigeno.Models.BookingAppointmentCustomed>();
    }
    <div class="reservation-container">
        <div class="page-header text-center mb-5 animate__animated animate__fadeIn">
            <h1 class="display-4">Mis Reservas</h1>
            <p class="lead">Gestiona tus próximas actividades en Expedición Oxígeno</p>
        </div>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger animate__animated animate__shakeX">
                <span class="me-2"><i class="fas fa-exclamation-circle"></i></span>@TempData["Error"]
            </div>
        }
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success animate__animated animate__fadeIn">
                <span class="me-2"><i class="fas fa-check-circle"></i></span>@TempData["Success"]
            </div>
        }

        <!-- Próximas Reservas -->
        <div class="mb-5">
            <h2 class="mb-4"><i class="fas fa-calendar-check me-2"></i>Próximas Reservas</h2>
            @if (!futuras.Any())
            {
                <div class="text-center py-5 animate__animated animate__fadeIn">
                    <div class="mb-4"><i class="fas fa-calendar-times fa-4x text-muted"></i></div>
                    <h4 class="text-muted">No tienes reservas futuras activas</h4>
                    <p class="text-muted mb-4">¡Es momento de vivir nuevas aventuras!</p>
                    <a href="@Url.Action("Index", "Reservas")" class="btn btn-Primary-ExpOxi mt-3">
                        <span class="me-2"><i class="fas fa-plus-circle"></i></span>Hacer una nueva reserva
                    </a>
                </div>
            }
            else
            {
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    @foreach (var reserva in futuras)
                    {
                        var timeZone = TimeZoneInfo.FindSystemTimeZoneById("Central America Standard Time");
                        var fecha = reserva.start != null && reserva.start.dateTime != null
                            ? TimeZoneInfo.ConvertTimeFromUtc(reserva.start.dateTime, timeZone)
                            : DateTime.MinValue;
                        var horaInicio = fecha;
                        var horaFin = reserva.end != null && reserva.end.dateTime != null
                            ? TimeZoneInfo.ConvertTimeFromUtc(reserva.end.dateTime, timeZone)
                            : DateTime.MinValue;
                        var cultura = new CultureInfo("es-ES");
                        var fechaTexto = fecha.ToString("dddd, dd 'de' MMMM 'de' yyyy", cultura);
                        var fechaFormateada = char.ToUpper(fechaTexto[0]) + fechaTexto.Substring(1);
                        var horaInicioFormateada = horaInicio.ToString("hh:mm tt");
                        var horaFinFormateada = horaFin.ToString("hh:mm tt");
                        <div class="col animate__animated animate__fadeIn">
                            <div class="card h-100 reservation-card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">@reserva.ServiceName</h5>
                                        <div class="reservation-icon">
                                            @if (reserva.ServiceName.Contains("Escalada"))
                                            {
                                                <span><i class="fas fa-mountain"></i></span>
                                            }
                                            else if (reserva.ServiceName.Contains("Cuerdas"))
                                            {
                                                <span><i class="fas fa-route"></i></span>
                                            }
                                            else if (reserva.ServiceName.Contains("Glider"))
                                            {
                                                <span><i class="fas fa-wind"></i></span>
                                            }
                                            else
                                            {
                                                <span><i class="fas fa-tree"></i></span>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="reservation-details">
                                        <div class="detail-item">
                                            <span><i class="far fa-calendar-alt"></i></span>
                                            <span>@fechaFormateada</span>
                                        </div>
                                        <div class="detail-item">
                                            <span><i class="far fa-clock"></i></span>
                                            <span>@horaInicioFormateada - @horaFinFormateada</span>
                                        </div>
                                        <div class="detail-item">
                                            <span><i class="fas fa-clock"></i></span>
                                            <span class="reservation-id">@reserva.Duration</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between">
                                        <form action="@Url.Action("CancelarReserva", "Reservas")" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@reserva.Id" />
                                            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('¿Estás seguro que deseas cancelar esta reserva?')">
                                                <span class="me-1"><i class="fas fa-times-circle"></i></span>Cancelar
                                            </button>
                                        </form>

                                        <a href="@Url.Action("Editar", "Reservas", new { id = reserva.Id })" class="btn btn-outline-primary">
                                            <span class="me-1"><i class="fas fa-edit"></i></span>Modificar
                                        </a>
                                    </div>
                                </div>

                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Reservas Pasadas -->
        <div>
            <h2 class="mb-4"><i class="fas fa-history me-2"></i>Reservas Pasadas</h2>
            @if (!pasadas.Any())
            {
                <div class="text-center py-5 animate__animated animate__fadeIn">
                    <div class="mb-4"><i class="fas fa-calendar-minus fa-4x text-muted"></i></div>
                    <h4 class="text-muted">No tienes reservas pasadas</h4>
                    <p class="text-muted mb-4">¡Tus aventuras te esperan!</p>
                </div>
            }
            else
            {
                <div class="row row-cols-1 row-cols-md-2 g-4">
                    @foreach (var reserva in pasadas)
                    {
                        var fecha = reserva.start != null && reserva.start.dateTime != null ? reserva.start.dateTime : DateTime.MinValue;
                        var horaInicio = fecha;
                        var horaFin = reserva.end != null && reserva.end.dateTime != null ? reserva.end.dateTime : DateTime.MinValue;
                        var cultura = new CultureInfo("es-ES");
                        var fechaTexto = fecha.ToString("dddd, dd 'de' MMMM 'de' yyyy", cultura);
                        var fechaFormateada = char.ToUpper(fechaTexto[0]) + fechaTexto.Substring(1);
                        var horaInicioFormateada = horaInicio.ToString("hh:mm tt");
                        var horaFinFormateada = horaFin.ToString("hh:mm tt");

                        <div class="col animate__animated animate__fadeIn">
                            <div class="card h-100 reservation-card reservation-card-past">
                                <div class="card-header bg-secondary">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">@reserva.ServiceName</h5>
                                        <div class="reservation-icon">
                                            @if (reserva.ServiceName.Contains("Escalada"))
                                            {
                                                <span><i class="fas fa-mountain"></i></span>
                                            }
                                            else if (reserva.ServiceName.Contains("Cuerdas"))
                                            {
                                                <span><i class="fas fa-route"></i></span>
                                            }
                                            else if (reserva.ServiceName.Contains("Glider"))
                                            {
                                                <span><i class="fas fa-wind"></i></span>
                                            }
                                            else
                                            {
                                                <span><i class="fas fa-tree"></i></span>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="reservation-details">
                                        <div class="detail-item">
                                            <span><i class="far fa-calendar-alt"></i></span>
                                            <span>@fechaFormateada</span>
                                        </div>
                                        <div class="detail-item">
                                            <span><i class="far fa-clock"></i></span>
                                            <span>@horaInicioFormateada - @horaFinFormateada</span>
                                        </div>
                                        <div class="detail-item">
                                            <span><i class="fas fa-clock"></i></span>
                                            <span class="reservation-id">@reserva.Duration</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer text-center">
                                    <span class="badge bg-secondary">Reserva finalizada</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
